#include <common.in>

RUNNER=web
TOOL=
INCLUDE_PATH="."
SERVER_PROFILE=dev
WEB_ROOT=.
WEB_CONFIG=etc
ACTION=serve
PIDFILE="$HOME/.xpws.pid"
REDIR=

while [ $# != 0 ]; do
  case $1 in
    -p)
      SERVER_PROFILE=$2
      shift 2
      ;;
    -r)
      DOCUMENT_ROOT=$2
      if [ ! -d "$DOCUMENT_ROOT" ] ; then
        echo "*** Document root $DOCUMENT_ROOT does not exist, exiting." >&2
        exit 3
      fi
      shift 2
      ;;
    -c)
      WEB_CONFIG=$2
      shift 2
      ;;
    -w)
      WEB_ROOT=$2
      shift 2
      ;;
    -l)
      REDIR="1>$2 2>&1"
      touch $2 || exit
      shift 2
      ;;
    -cp)
      INCLUDE_PATH=${INCLUDE_PATH}${PATHSEP}$2
      shift 2
      ;;
    -?)
      RUNNER=class
      TOOL="xp.scriptlet.Usage|xpws.txt"
      WEB_CONFIG=?
      break
      ;;
    info)
      RUNNER=class
      TOOL='xp.scriptlet.Inspect|${WEB_ROOT}|${WEB_CONFIG}|${SERVER_PROFILE}|${ADDR}'
      shift 1
      ;;
    start|stop|status|serve)
      ACTION=$1
      shift 1
      ;;
    *:*)
      server=${1%:*}
      port=${1#*:}
      shift 1
      break
      ;;
    *)
      server=$1
      shift 1
      break
      ;;
  esac
done

ADDR=${server-localhost}:${port-8080}
eval 'TOOL="'$TOOL'"'
EXEC($RUNNER, $INCLUDE_PATH, $TOOL)

#include <instance.in>

if [ $WEB_CONFIG != "?" ] && [ ! -e "$WEB_CONFIG/web.ini" ] ; then
  echo "*** Cannot find the web configuration web.ini in $WEB_CONFIG/, exiting." >&2
  exit 3
fi

if [ $RUNNER = class ] ; then
  ${XP_EXE}${ifs}${args}${ifs}$tool ${ARGS} "$@"
elif [ $ACTION = status ] ; then
  if [ -f "$PIDFILE" ] ; then
    echo "[xpws-"$(cat "$PIDFILE")"] running "$(realpath "$PIDFILE")
  else
    echo "xpws not running"
    exit 1
  fi
elif [ $ACTION = stop ] ; then
  if [ -f "$PIDFILE" ] ; then
    running=$(cat "$PIDFILE")
    PID=${running#*'#'}
    echo "[xpws-$running] shutting down..."
    kill -TERM $PID
    rm "$PIDFILE"
  else
    echo "*** xpws not running"
    exit 1
  fi
elif [ -f "$PIDFILE" ] ; then
  echo "*** xpws already running"
  exit 255
else

  if [ "" = "$DOCUMENT_ROOT" ] ; then
    if [ -d "$WEB_ROOT/static" ] ; then
      DOCUMENT_ROOT="$WEB_ROOT/static"
    else
      DOCUMENT_ROOT=.
    fi
  else
    DOCUMENT_ROOT=${DOCUMENT_ROOT%/}
  fi

  export WEB_ROOT
  export SERVER_PROFILE
  export DOCUMENT_ROOT

  ${XP_EXE}${ifs}-S${ifs}${ADDR}${ifs}-t${ifs}"${DOCUMENT_ROOT}"${ifs}-duser_dir="$WEB_CONFIG"${ifs}${args}${ifs}$tool ${ARGS} "$@" $REDIR &
  PID=$!

  if [ serve = $ACTION ] ; then
    echo "[xpws-$SERVER_PROFILE#$PID] running $ADDR @ $WEB_ROOT - Press <Enter> to exit"
    read enter
    echo "[xpws-$SERVER_PROFILE#$PID] shutting down..."
    kill -TERM $PID
  else
    echo "[xpws-$SERVER_PROFILE#$PID] running $ADDR @ $WEB_ROOT - Use xpws stop to end"
    echo $SERVER_PROFILE#$PID > "$PIDFILE"
  fi
fi